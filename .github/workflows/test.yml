name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  pester-tests:
    name: Pester Tests
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0
          Import-Module Pester -MinimumVersion 5.0

      - name: Run Pester Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $true
          $config.Filter.ExcludeTag = @("Integration")
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          
          Invoke-Pester -Configuration $config

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  go-tests:
    name: Go Tests
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run Go Tests
        run: go test -v ./cmd/...

  security:
    name: Security Checks
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for unsafe Remove-Item usage
        shell: pwsh
        run: |
          Write-Host "Checking for unsafe Remove-Item patterns..."
          $unsafePatterns = Get-ChildItem -Path . -Filter *.ps1 -Recurse | 
              Select-String -Pattern 'Remove-Item.*-Recurse.*-Force' |
              Where-Object { $_.Line -notmatch 'Remove-SafeItem|#.*Remove-Item' }
          
          if ($unsafePatterns) {
              Write-Host "Potentially unsafe Remove-Item usage found:" -ForegroundColor Yellow
              $unsafePatterns | ForEach-Object { Write-Host $_.Line }
              Write-Host "Consider using Remove-SafeItem instead" -ForegroundColor Yellow
          } else {
              Write-Host "No unsafe Remove-Item patterns found" -ForegroundColor Green
          }

      - name: Verify protected paths
        shell: pwsh
        run: |
          Write-Host "Verifying protected path implementation..."
          . .\lib\core\base.ps1
          
          $protectedPaths = @(
              "C:\Windows",
              "C:\Windows\System32",
              "C:\Program Files"
          )
          
          $allProtected = $true
          foreach ($path in $protectedPaths) {
              if (-not (Test-ProtectedPath -Path $path)) {
                  Write-Host "FAIL: $path is not protected!" -ForegroundColor Red
                  $allProtected = $false
              } else {
                  Write-Host "OK: $path is protected" -ForegroundColor Green
              }
          }
          
          if (-not $allProtected) {
              exit 1
          }
